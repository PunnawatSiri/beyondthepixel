# Beyond the Pixel
___

This repository contains the calibration code (**Calibration**) and the deep learning code (**Learning Tasks**) for the paper [_Beyond the Pixel: a Photometrically Calibrated HDR Dataset for Luminance and Color Prediction_](https://lvsn.github.io/beyondthepixel/)
## Requirements

```sh
pip install pytorch_lightning matplotlib skylibs glob2 opencv-contrib-python collections omegaconf natsort configargparse
```

Additionally, MATLAB is required for the HDR-VDP-3 metric. 

## Calibration
To run the calibration process for your own camera setup as it is done in the paper, follow the README in the __Calibration__ folder.

## Learning Tasks
The pipeline used for learning depends on the desired task.
![alt text](<./Learning Tasks/fixupunet/architecture.png>)

__Per-pixel luminance__ outputs an HDR image and the scale needed to bring it to absolute luminance.

__Per-pixel color__ predicts the temperature map directly.

__Planar illuminance__ generate only the illuminance scalar.

### Dataset preparation
If working with the full dataset (available at http://hdrdb.com/indoor-hdr-photometric/), it needs to be split in train/test/val , inpainted and rescaled to manageable size. The following script automate this to the setup used in the paper.

```
python prepare_dataset.py [path_to_full_dataset]
```

### Training
For convenience, 3 config files are provided in __configs/__, one for each task.

```
python train.py --config [config_file]
```

### Testing
When testing, it is best to link to the config file generated by the training script (by default in __checkpoints/[name]/lightning_logs/version\_[x]/config.txt__)

The __test.py__ script generate the inference predictions.
```
python test.py --config [config_file]
```

The __metrics.py__ script computes the metrics and generate visualisations from the inference predictions.
```
python metrics.py --config [config_file]
```

### Fine-tuning
When fine-tuning, the config file must be modified to increase the _n_epoch_ property.

When fine-tuning, it is best to link to the config file generated by the training script (by default in __checkpoints/[name]/lightning_logs/version\_[x]/config.txt__)

```
python fine-tune.py --config [config_file]
```

### Pre-trained weights
If you wish to test or fine-tune the weights used in the paper, you can download them and place them in the __checkpoints/__ folder.

<https://hdrdb-public.s3.valeria.science/indoor_photometric/[Experiment_name].zip>

| Experiment_name | Mode | In paper | Link |
| --- | ----------- | ----- | ----- |
| Luminance_linear | Luminance | Table 1 | [link](https://hdrdb-public.s3.valeria.science/indoor_photometric/Luminance_linear.zip) |
| Luminance_gamma | Luminance | Table 1 | [link](https://hdrdb-public.s3.valeria.science/indoor_photometric/Luminance_gamma.zip) |
| Luminance_noise | Luminance | Table 1 | [link](https://hdrdb-public.s3.valeria.science/indoor_photometric/Luminance_noise.zip) |
| Luminance_quantized | Luminance | Table 1 | [link](https://hdrdb-public.s3.valeria.science/indoor_photometric/Luminance_quantized.zip) |
| Luminance_LDR | Luminance | Table 1 | [link](https://hdrdb-public.s3.valeria.science/indoor_photometric/Luminance_LDR.zip) |
| Luminance_LDR_fine_tune | Luminance | Table 3 | [link](https://hdrdb-public.s3.valeria.science/indoor_photometric/Luminance_LDR_fine_tune.zip) |
| Temperature_WB_rand_augment | Temperature | Figure 7 | [link](https://hdrdb-public.s3.valeria.science/indoor_photometric/Temperature_WB_rand_augment.zip) |
| Temperature_WB_augment_theta_fine_tune | Temperature | Table 3 | [link](https://hdrdb-public.s3.valeria.science/indoor_photometric/Temperature_WB_augment_theta_fine_tune.zip) |
| illum_hemi_HDR | Illuminance | Table 2 | [link](https://hdrdb-public.s3.valeria.science/indoor_photometric/illum_hemi_HDR.zip) |
| illum_hemi_LDR_scale | Illuminance | Table 2 | [link](https://hdrdb-public.s3.valeria.science/indoor_photometric/illum_hemi_LDR_scale.zip) |
| illum_hemi_LDR | Illuminance | Table 2 | [link](https://hdrdb-public.s3.valeria.science/indoor_photometric/illum_hemi_LDR.zip) |
| illum_120_HDR | Illuminance | Table 2 | [link](https://hdrdb-public.s3.valeria.science/indoor_photometric/illum_120_HDR.zip) |
| illum_120_LDR_scale | Illuminance | Table 2 | [link](https://hdrdb-public.s3.valeria.science/indoor_photometric/illum_120_LDR_scale.zip) |
| illum_120_LDR | Illuminance | Table 2 | [link](https://hdrdb-public.s3.valeria.science/indoor_photometric/illum_120_LDR.zip) |
| illum_60_HDR | Illuminance | Table 2 | [link](https://hdrdb-public.s3.valeria.science/indoor_photometric/illum_60_HDR.zip) |
| illum_60_LDR_scale | Illuminance | Table 2 | [link](https://hdrdb-public.s3.valeria.science/indoor_photometric/illum_60_LDR_scale.zip) |
| illum_60_LDR | Illuminance | Table 2 | [link](https://hdrdb-public.s3.valeria.science/indoor_photometric/illum_60_LDR.zip) |
| illum_rand_HDR | Illuminance | Table 2 | [link](https://hdrdb-public.s3.valeria.science/indoor_photometric/illum_rand_HDR.zip) |
| illum_rand_LDR_scale | Illuminance | Table 2 | [link](https://hdrdb-public.s3.valeria.science/indoor_photometric/illum_rand_LDR_scale.zip) |
| illum_rand_LDR | Illuminance | Table 2 | [link](https://hdrdb-public.s3.valeria.science/indoor_photometric/illum_rand_LDR.zip) |
| illum_120_LDR_theta | Illuminance | Table 3 | [link](https://hdrdb-public.s3.valeria.science/indoor_photometric/illum_120_LDR_theta.zip) |


## Paper


> __Beyond the Pixel: a Photometrically Calibrated HDR Dataset for Luminance and Color Prediction__  
> [Christophe Bolduc](https://christophebolduc.ca/), [Justine Giroux](https://lvsn.github.io/beyondthepixel/), [Marc Hébert](https://cervo.ulaval.ca/en/marc-hebert), [Claude Demers](https://www.arc.ulaval.ca/enseignants-personnel/professeurs/claude-mh-demers), [Jean-François Lalonde](http://www.jflalonde.ca/)  
> _International Conference on Computer Vision (__ICCV__), 2023_  
> __[Project page](https://lvsn.github.io/beyondthepixel/)&nbsp;/ [Paper](https://arxiv.org/abs/2304.12372)&nbsp;/ [Dataset](http://hdrdb.com/indoor-hdr-photometric/)&nbsp;/ [BibTeX](https://lvsn.github.io/beyondthepixel/assets/bibtex.txt)__


